<?xml version="1.0" encoding="UTF-8"?>
<!-- DTD지정  -->
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.itwillbs.mappers.productionMapper">

<!-- 생산 목록 -->
	<select id="getProductionList" resultType="com.itwillbs.domain.ProductionVO">
		SELECT pd.production_id, pd.production_line, pd.product_id, p.product_name, pd.plan_qty, e.emp_name, pc.* 
		FROM production pd
		JOIN product p ON pd.product_id = p.product_id
		JOIN employee e ON pd.production_emp = e.emp_id
		LEFT JOIN pr_complete pc ON pd.production_id = pc.production_id
	</select>
<!-- 생산 목록 -->

<!-- 생산 등록 -->
	<!-- 작업지시번호 조회 -->
	  <select id="insertSearch" resultType="com.itwillbs.domain.ProductionVO">
		SELECT pd.production_id, pd.production_date, pd.production_line, pd.product_id, 
		p.product_name, pd.plan_qty, e.emp_name, pc.production_status
		FROM production pd
		JOIN product p ON pd.product_id = p.product_id
		JOIN employee e ON pd.production_emp = e.emp_id
		LEFT JOIN pr_complete pc ON pd.production_id = pc.production_id
		WHERE pd.production_id = #{production_id} AND pd.workOrder_status != '완료'
	  </select>
	<!-- 작업지시번호 조회 -->
	
	<!-- [혼합] DB 등록 -->
	  <insert id="insertStage1">
		INSERT INTO pr_complete 
		(production_id, production_status, stage1_defCode, stage1_defQty, stage1_date)
		VALUES
	    (#{production_id}, #{production_status}, #{stage1_defCode}, ${stage1_defQty}, now())
	  </insert>
	  
	  <update id="updateWostatus">
	  UPDATE production
	  SET workOrder_status = '진행중'
	  WHERE production_id = #{production_id};
	  </update>
	<!-- [혼합] DB 등록 -->
	
	<!-- [주입] DB 등록 -->
	  <update id="insertStage2" parameterType="com.itwillbs.domain.ProductionVO">
	 	UPDATE pr_complete 
		SET production_status = #{production_status}, stage2_defCode = #{stage2_defCode}, stage2_defQty = #{stage2_defQty}, stage2_date = now()
		WHERE production_id = #{production_id};
	  </update>
	<!-- [주입] DB 등록 -->
	
	<!-- [포장] DB 등록 -->
	  <update id="insertStage3" parameterType="com.itwillbs.domain.ProductionVO">
	 	UPDATE pr_complete 
		SET production_status = #{production_status}, stage3_defCode = #{stage3_defCode}, stage3_defQty = #{stage3_defQty}, stage3_date = now()
		WHERE production_id = #{production_id};
	  </update>
	  
	  <update id="updateProductionQty" parameterType="com.itwillbs.domain.ProductionVO">
	    UPDATE pr_complete pc
        JOIN production pd ON pc.production_id = pd.production_id
		SET pd.production_qty = pd.plan_qty - (pc.stage1_defQty + pc.stage2_defQty + pc.stage3_defQty)
		WHERE pc.production_id = #{production_id};
	  </update>
	<!-- [포장] DB 등록 -->
<!-- 생산 등록 -->



</mapper>